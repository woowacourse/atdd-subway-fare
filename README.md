# atdd-subway-fare

## 📜 구현할 기능 목록
- [x] **배포하기**
    - [x] Nginx로 Reverse Proxy 구성하기
        - [x] TLS 설정
    - [x] application.properties를 통한 다양한 환경의 DB 구성
        - [x] Test 환경 : H2
        - [x] Local 환경 : Mysql (Docker)
        - [x] Production 환경 : Mysql (Server)
        - [x] Remote 환경 : Mysql (다른 인스턴스 Server)

- [x] **전체 조회 기능**
    - [x] GET: /stations/transfer로 환승 가능한 역의 목록을 노선 이름과 함께 반환

- [x] **요금 조회 기능**
    - [x] 거리에 따른 운임 계산 로직 구현
        - [x] 기본 요금 : 1250원
        - [x] 10km 초과 ~ 50km 이하 : 5km마다 100원
        - [x] 50km 초과 시 : 8km마다 100원

- [x] **요금 정책 추가**
    - [x] 노선별 추가 요금 구현
        - [x] 노선이 추가 요금에 대한 정보를 가지도록 CRUD 로직 수정
        - [x] 경로 조회 시, 추가 요금이 가장 높은 노선의 금액을 운임 계산에 포함
    - [x] 로그인 사용자의 경우 연령별 요금으로 계산
        - [x] 청소년 *(13세 이상 ~ 19세 미만)* : 운임에서 350원을 공제한 금액의 20% 할인
        - [x] 어린이 *(6세 이상 ~ 13세 미만)* : 운임에서 350원을 공제한 금액의 50% 할인
        - [x] 로그인이 되지 않은 사용자는 앞선 계산 로직으로 요금을 산정한다

- [x] **프론트 측 추가 요구 사항**
    - [x] 환승역 정보를 포함한 Station 반환하는 API 구현
        - [x] GET: /stations/transfer
            ```json
            [
                {
                    "id": 1,
                    "name": "강남역",
                    "transfer": ["1호선", "2호선"]
                }
            ]
            ```
    - [x] 중복된 Email을 검증하는 API 구현
        - [x] POST: /members/email-check
            - [x] 성공 시 200, 오류 시 409 응답
            ```json
            {
              "email": "test@test.com"
            }
            ```
    - [x] GET /lines에 sections 추가
    - [x] GET /stations DB 등록 최근순으로 반환하기

## 🎯 예외 처리 경우 목록
- [x] **AUTH**
    - [x] 역/노선/구간/경로 서비스 사용
        - [x] 조회는 누구나 가능하나, 추가/수정/삭제는 로그인 된 사용자만 가능 *(상태코드: 401)*
    - [x] 멤버 서비스 사용
        - [x] 로그인이 된 사용자에 한에 사용자 조회/수정/삭제 기능 사용 가능 *(상태코드: 401)*

- [x] **LINE**
    - [x] 노선 관련 로직
        - [x] 중복되는 이름의 노선은 등록할 수 없음 *(상태코드: 409)*
        - [x] 중복되는 색상의 노선은 등록할 수 없음 *(상태코드: 409)*
        - [x] 중복되는 이름의 노선으로 수정할 수 없음 *(상태코드: 409)*
        - [x] 중복되는 색상의 노선으로 수정할 수 없음 *(상태코드: 409)*
        - [x] 노선 등록 시, 노선의 이름은 2자 이상의 한글/숫자로 구성되며, 공백은 허용하지 않음 *(상태코드: 400)*
        - [x] 노선 수정 시, 노선의 이름은 2자 이상의 한글/숫자로 구성되며, 공백은 허용하지 않음 *(상태코드: 400)*
        - [x] 등록되지 않은 노선에 대한 노선 조회 요청은 처리할 수 없음 *(상태코드: 404)*
        - [x] 등록되지 않은 노선에 대한 노선 삭제 요청은 처리할 수 없음 *(상태코드: 404)*
    - [x] 구간 관련 로직
        - [x] 구간 추가 로직
            - [x] 상행역/하행역/거리가 안 채워져 있거나, 유효하지 않은 값이라면 예외처리 *(상태코드: 400)*
            - [x] 구간 등록 시 상행역과 하행역은 같을 수 없음 *(상태코드: 400)*
            - [x] 요청한 노선에 상행역/하행역이 둘 다 없다면 예외처리 *(상태코드)*
            - [x] 요청한 노선에 상행역/하행역이 둘 다 이미 등록되어 있다면 예외처리 *(상태코드: 400)*
            - [x] 구간 등록 시 기존 구간보다 크면 등록할 수 없다 *(상태코드: 400)* 
            - [x] 상행역/하행역이 DB에 등록되어 있지 않은 역이라면 예외처리 *(상태코드: 404)*
            - [x] 등록되지 않은 노선에 대해 구간 추가 요청은 처리할 수 없음 *(상태코드: 404)*
        - [x] 구간 삭제 로직
            - [x] 구간이 하나인 노선에서는 구간 제거를 할 수 없음 *(상태코드: 400)*
            - [x] 구간 삭제 시 요청 노선에 포함되지 않은 역이라면 처리할 수 없음 *(상태코드: 400)*
            - [x] 등록되지 않은 노선에 대해 구간 삭제 요청은 처리할 수 없음 *(상태코드: 404)*

- [x] **MEMBER**
    - [x] 회원 가입 
        - [x] Email 형식이 유효해야 함 *(상태코드: 400)*
        - [x] 나이는 양수여야 함 *(상태코드: 400)*
        - [x] Password 형식이 유효해야 함 *(상태코드: 400)*
        - [x] 이미 가입된 Email은 사용할 수 없음 *(상태코드: 409)*

- [x] **PATH**
    - [x] 경로 관련 로직
        - [x] 쿼리스트링으로 넘어오는 시작점과 도착점은 빈 값일 수 없음 *(상태코드: 400)*
        - [x] 출발역과 도착역이 같을 수 없음  *(상태코드: 400)*
        - [x] 출발역과 도착역 사이에서 경로를 조회할 수 없는 경우 에외를 발생시킴 *(상태코드: 404)* 
        - [x] 등록되지 않은 역에 대해서는 경로 조회 할 수 없음 *(상태코드: 404)*
    - [x] 요금 관련 로직
        - [x] 두 역의 경로가 10000km가 넘어가는 경우 요금을 조회할 수 없음 *(상태코드: 500)*
            - *수도권 전철 노선 길이의 총합은 1,221.4km임*
            - *참고: https://ko.wikipedia.org/wiki/%EC%88%98%EB%8F%84%EA%B6%8C_%EC%A0%84%EC%B2%A0*
            - //TODO: 10000Km가 넘어가는 경우에 뻗는 것이라면, 요금 요청 전에 처리하는게 맞지 않을까?
            
- [x] **STATION**
    - [x] 역 관련 로직
        - [x] 중복되는 이름의 역은 등록할 수 없음 *(상태코드: 409)*
        - [x] 역 등록 시, 역의 이름은 2자 이상 한글/숫자로 구성되며, 공백은 허용하지 않음 *(상태코드: 400)*
        - [x] 등록되지 않은 역에 대한 삭제 요청은 처리할 수 없음 *(상태코드: 404)*
        - [x] 구간에 등록되어 있는 역은 삭제할 수 없음 *(상태코드: 400)*

## ✂ 리팩토링 중점 사안
- [x] 수정 시에도 유효한 값이 넘어오는지 확인하기
- [x] 서비스 클래스에 `@transactional` 검토하기
- [x] 노선 색상에 대한 유효 검사 확인하기
- [x] 구간 삭제 시 해당 Line의 구간들을 이어붙이기 
- [x] 역 조회 시, 최근에 생성된 역 순서대로 반환할 것
- [ ] 단위테스트 작성하기
- [ ] 특정 계층에서 사용하는 예외를 다른 Layer 클래스에서 사용하지 않도록 리팩토링
    - [ ] dao단의 에러는 dao에서만! 그냥 RuntimeException으로 바꾸는게 나을수도
- [ ] ArgumentResolver에서 다형성을 통해 Optional을 제거해보기
- [ ] 확장성이 필요하지 않다고 생각하는 어플리케이션에서는 적당히 Validation
    - [ ] 여기서 Valid된 필드에 대해서는 신뢰
    - [ ] 가령... Dto에서는 Null만 확인, 후에는 Null 검사 할 필요 없음
- [ ] NamedParameterJdbcTemplate 도입
- [x] 도메인 필드 값에 대해 원시값 포장
- [x] 매직 넘버 상수화
- [x] 디미터의 법칙 준수
- [x] 필요없는 변수 할당 제거
- [x] 주 생성자, 부 생성자 분리

## 🤔 질문 사항
- Exception 처리 전략
    - Exception을 어떤 패키지에 두어야 하는가?
- Optional을 통해 해당 필드로 등록된 정보가 있는지 조회를 한 다음, 서비스 단에서 Optional 객체 유무에 따라 예외를 처리해줌
    - DuplicateKeyException은 `import org.springframework.dao.DuplicateKeyException` 소속인데, service 단에서 발생시킬 예외를 dao 소속의 예외를 상속해 사용해도 괜찮을까?
- Domain에서 걸러줄 예외 VS RequestDto에서 걸러줄 예외
    - Validation을 어느 레이어에서 얼마만큼 하는게 좋을까?
    - RequestDto에서 다 검증하면 도메인은 그냥 빈 깡통마냥 있음
    - 근데 valid를 할꺼면 최대한 앞단에서 하는게 좋은 것 같긴함
    - 둘 다 똑같은 것을 두번 해줘야 하나?
- 인수테스트만 해도 괜찮을까? 실제 시나리오를 반영시키는데 충분할 거 같기도하다
- Argument Resolver에서 Optional<LoginMember>를 반환
    - members/me & path의 fare 계산 로직에서 LoginMember를 알아야함 근데...
        - members/me 에서는 필수
        - path 에서는 선택
    - 이러다 보니 Optional<LoginMember>를 반환해 필수로 들어와야 하는 members/me controller에서 validation
        - 좋은 방법인지?
